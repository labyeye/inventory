<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0"
    />
    <meta name="description" content="POS - Bootstrap Admin Template" />
    <meta
      name="keywords"
      content="admin, estimates, bootstrap, business, corporate, creative, invoice, html5, responsive, Projects"
    />
    <meta name="author" content="Dreamguys - Bootstrap Admin Template" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Dreams Pos admin template</title>
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="assets/img/favicon.jpg"
    />
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/animate.css" />
    <link rel="stylesheet" href="assets/plugins/select2/css/select2.min.css" />
    <link rel="stylesheet" href="assets/css/dataTables.bootstrap4.min.css" />
    <link
      rel="stylesheet"
      href="assets/plugins/fontawesome/css/fontawesome.min.css"
    />
    <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>
  <body>
    <div id="global-loader">
      <div class="whirly-loader"></div>
    </div>

    <div class="main-wrapper">
      <!-- Header and Sidebar code here (same as before) -->

      <div class="page-wrapper">
        <div class="content">
          <div class="page-header">
            <div class="page-title">
              <h4>Product Edit</h4>
              <h6>Update your product</h6>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-lg-3 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="productName" />
                  </div>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Category</label>
                    <select class="select" id="categorySelect">
                      <option value="">Select Category</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Sub Category</label>
                    <select class="select" id="subcategorySelect">
                      <option value="">Select Sub Category</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Brand</label>
                    <input type="text" id="brand" />
                  </div>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Quantity</label>
                    <input type="text" id="quantity" />
                  </div>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="location" />
                  </div>
                </div>
                <div class="col-lg-12">
                  <a
                    href="javascript:void(0);"
                    class="btn btn-submit me-2"
                    id="updateProduct"
                    >Update</a
                  >
                  <a href="productlist.html" class="btn btn-cancel">Cancel</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="assets/js/jquery-3.6.0.min.js"></script>
    <script src="assets/js/feather.min.js"></script>
    <script src="assets/js/jquery.slimscroll.min.js"></script>
    <script src="assets/js/jquery.dataTables.min.js"></script>
    <script src="assets/js/dataTables.bootstrap4.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/plugins/select2/js/select2.min.js"></script>
    <script src="assets/plugins/sweetalert/sweetalert2.all.min.js"></script>
    <script src="assets/plugins/sweetalert/sweetalerts.min.js"></script>
    <script src="assets/js/script.js"></script>
    <script type="module">
      import { db, storage } from "./assets/js/firebase.js";
import {
  doc,
  getDoc,
  updateDoc,
  collection,
  getDocs,
} from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
import {
  ref,
  uploadBytesResumable,
  getDownloadURL,
} from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get("id");

if (!productId) {
  Swal.fire({
    icon: "error",
    title: "Error",
    text: "No product ID specified!",
  }).then(() => {
    window.location.href = "productlist.html";
  });
}

// Global variable to store subcategories data
let subcategoriesData = [];

document.addEventListener("DOMContentLoaded", async function () {
  try {
    await populateCategories();
    await loadProductData();
    setupEventListeners();
  } catch (error) {
    console.error("Error during initialization:", error);
    Swal.fire({
      icon: "error",
      title: "Error",
      text: "Failed to initialize: " + error.message,
    });
  }
});

async function populateCategories() {
  try {
    // Fetch categories
    const categoriesSnapshot = await getDocs(collection(db, "categories"));
    const categorySelect = document.getElementById("categorySelect");
    categorySelect.innerHTML = '<option value="">Select Category</option>';

    categoriesSnapshot.forEach((doc) => {
      const category = doc.data();
      const option = document.createElement("option");
      option.value = doc.id;
      option.textContent = category.name;
      categorySelect.appendChild(option);
    });

    // Fetch subcategories
    const subcategoriesSnapshot = await getDocs(collection(db, "subcategories"));
    subcategoriesData = []; // Use the global variable
    subcategoriesSnapshot.forEach((doc) => {
      const subcategory = doc.data();
      subcategoriesData.push({
        id: doc.id,
        name: subcategory.name,
        categoryId: subcategory.categoryId,
      });
    });
    
    console.log("Loaded subcategories:", subcategoriesData);
  } catch (error) {
    console.error("Error loading categories and subcategories:", error);
    throw error;
  }
}

function updateSubcategories(categoryId) {
  const subcategorySelect = document.getElementById("subcategorySelect");
  subcategorySelect.innerHTML = '<option value="">Select Sub Category</option>';

  // If no category is selected, just clear the subcategories and return
  if (!categoryId) {
    return;
  }

  console.log("Updating subcategories for category:", categoryId);
  
  // Filter subcategories based on the selected category
  const filteredSubcategories = subcategoriesData.filter(
    (subcat) => subcat.categoryId === categoryId
  );

  console.log("Filtered subcategories:", filteredSubcategories);

  // Populate subcategories dropdown
  filteredSubcategories.forEach((subcat) => {
    const option = document.createElement("option");
    option.value = subcat.id;
    option.textContent = subcat.name;
    subcategorySelect.appendChild(option);
  });
}

async function loadProductData() {
  try {
    const productRef = doc(db, "products", productId);
    const productSnap = await getDoc(productRef);

    if (!productSnap.exists()) {
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Product not found!",
      }).then(() => {
        window.location.href = "productlist.html";
      });
      return;
    }

    const productData = productSnap.data();
    console.log("Product Data:", productData);

    // Populate form fields
    document.getElementById("productName").value = productData.name || "";
    document.getElementById("brand").value = productData.brand || "";
    document.getElementById("quantity").value = productData.quantity || "0";
    document.getElementById("location").value = productData.location || "";

    // Set category if it exists
    if (productData.categoryId) {
      document.getElementById("categorySelect").value = productData.categoryId;
      
      // Update subcategories based on the selected category
      updateSubcategories(productData.categoryId);
      
      // Set subcategory if it exists (with a small delay to ensure options are populated)
      if (productData.subCategoryId) {
        setTimeout(() => {
          const subcategorySelect = document.getElementById("subcategorySelect");
          subcategorySelect.value = productData.subCategoryId;
        }, 200);
      }
    }
  } catch (error) {
    console.error("Error loading product data:", error);
    throw error;
  }
}

function setupEventListeners() {
  // Set up category change event
  document.getElementById("categorySelect").addEventListener("change", function () {
    updateSubcategories(this.value);
  });

  // Set up update button click event
  document.getElementById("updateProduct").addEventListener("click", updateProduct);
}

async function updateProduct() {
  const productName = document.getElementById("productName").value.trim();
  if (!productName) {
    Swal.fire({
      icon: "error",
      title: "Validation Error",
      text: "Product name cannot be empty!",
    });
    return;
  }

  try {
    Swal.fire({
      title: "Updating Product",
      text: "Please wait...",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    // Get category and subcategory info
    const categorySelect = document.getElementById("categorySelect");
    const subcategorySelect = document.getElementById("subcategorySelect");

    const categoryId = categorySelect.value || null;
    let categoryName = null;
    if (categoryId && categorySelect.selectedIndex > 0) {
      categoryName = categorySelect.options[categorySelect.selectedIndex].text;
    }

    const subcategoryId = subcategorySelect.value || null;
    let subcategoryName = null;
    if (subcategoryId && subcategorySelect.selectedIndex > 0) {
      subcategoryName = subcategorySelect.options[subcategorySelect.selectedIndex].text;
    }

    console.log("Update with category:", categoryId, categoryName);
    console.log("Update with subcategory:", subcategoryId, subcategoryName);

    const productData = {
      name: productName,
      categoryId: categoryId,
      categoryName: categoryName,
      subCategoryId: subcategoryId,
      subCategoryName: subcategoryName,
      brand: document.getElementById("brand").value || "",
      quantity: parseInt(document.getElementById("quantity").value) || 0,
      location: document.getElementById("location").value || "",
      updatedAt: new Date(),
    };

    await updateDoc(doc(db, "products", productId), productData);

    Swal.fire({
      icon: "success",
      title: "Success",
      text: "Product updated successfully!",
    }).then(() => {
      window.location.href = "productlist.html";
    });
  } catch (error) {
    console.error("Error updating product:", error);
    Swal.fire({
      icon: "error",
      title: "Error",
      text: "Failed to update product: " + error.message,
    });
  }
}
    </script>
  </body>
</html>
