<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0"
    />
    <meta name="description" content="POS - Bootstrap Admin Template" />
    <meta
      name="keywords"
      content="admin, estimates, bootstrap, business, corporate, creative, invoice, html5, responsive, Projects"
    />
    <meta name="author" content="Dreamguys - Bootstrap Admin Template" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Dreams Pos admin template</title>

    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="assets/img/favicon.png"
    />

    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />

    <link rel="stylesheet" href="assets/css/animate.css" />

    <link rel="stylesheet" href="assets/plugins/select2/css/select2.min.css" />

    <link rel="stylesheet" href="assets/css/dataTables.bootstrap4.min.css" />

    <link
      rel="stylesheet"
      href="assets/plugins/fontawesome/css/fontawesome.min.css"
    />
    <link rel="stylesheet" href="assets/plugins/fontawesome/css/all.min.css" />

    <link rel="stylesheet" href="assets/css/style.css" />
  </head>
  <body>
    <div id="global-loader">
      <div class="whirly-loader"></div>
    </div>

    <div class="main-wrapper">
      <div class="header">
        <div class="header-left active">
          <a href="index.html" class="logo">
            <img src="assets/img/logo.png" alt="" />
          </a>
          <a href="index.html" class="logo-small">
            <img src="assets/img/logo-small.png" alt="" />
          </a>
          <a id="toggle_btn" href="javascript:void(0);"> </a>
        </div>

        <a id="mobile_btn" class="mobile_btn" href="#sidebar">
          <span class="bar-icon">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </a>

        <ul class="nav user-menu">
          <li class="nav-item">
            <div class="top-nav-search">
              <a href="javascript:void(0);" class="responsive-search">
                <i class="fa fa-search"></i>
              </a>
              <form action="#">
                <div class="searchinputs">
                  <input type="text" placeholder="Search Here ..." />
                  <div class="search-addon">
                    <span
                      ><img src="assets/img/icons/closes.svg" alt="img"
                    /></span>
                  </div>
                </div>
                <a class="btn" id="searchdiv"
                  ><img src="assets/img/icons/search.svg" alt="img"
                /></a>
              </form>
            </div>
          </li>

          <li class="nav-item dropdown has-arrow flag-nav">
            <a
              class="nav-link dropdown-toggle"
              data-bs-toggle="dropdown"
              href="javascript:void(0);"
              role="button"
            >
              <img src="assets/img/flags/us1.png" alt="" height="20" />
            </a>
            <div class="dropdown-menu dropdown-menu-right">
              <a href="javascript:void(0);" class="dropdown-item">
                <img src="assets/img/flags/us.png" alt="" height="16" /> English
              </a>
              <a href="javascript:void(0);" class="dropdown-item">
                <img src="assets/img/flags/fr.png" alt="" height="16" /> French
              </a>
              <a href="javascript:void(0);" class="dropdown-item">
                <img src="assets/img/flags/es.png" alt="" height="16" /> Spanish
              </a>
              <a href="javascript:void(0);" class="dropdown-item">
                <img src="assets/img/flags/de.png" alt="" height="16" /> German
              </a>
            </div>
          </li>

          <li class="nav-item dropdown">
            <a
              href="javascript:void(0);"
              class="dropdown-toggle nav-link"
              data-bs-toggle="dropdown"
            >
              <img src="assets/img/icons/notification-bing.svg" alt="img" />
              <span class="badge rounded-pill">4</span>
            </a>
            <div class="dropdown-menu notifications">
              <div class="topnav-dropdown-header">
                <span class="notification-title">Notifications</span>
                <a href="javascript:void(0)" class="clear-noti"> Clear All </a>
              </div>
              <div class="noti-content">
                <ul class="notification-list">
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-02.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">John Doe</span> added new
                            task
                            <span class="noti-title"
                              >Patient appointment booking</span
                            >
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">4 mins ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-03.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">Tarah Shropshire</span>
                            changed the task name
                            <span class="noti-title"
                              >Appointment booking with payment gateway</span
                            >
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">6 mins ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-06.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">Misty Tison</span> added
                            <span class="noti-title">Domenic Houston</span> and
                            <span class="noti-title">Claire Mapes</span> to
                            project
                            <span class="noti-title"
                              >Doctor available module</span
                            >
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">8 mins ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-17.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">Rolland Webber</span>
                            completed task
                            <span class="noti-title"
                              >Patient and Doctor video conferencing</span
                            >
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">12 mins ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="notification-message">
                    <a href="activities.html">
                      <div class="media d-flex">
                        <span class="avatar flex-shrink-0">
                          <img alt="" src="assets/img/profiles/avatar-13.jpg" />
                        </span>
                        <div class="media-body flex-grow-1">
                          <p class="noti-details">
                            <span class="noti-title">Bernardo Galaviz</span>
                            added new task
                            <span class="noti-title">Private chat module</span>
                          </p>
                          <p class="noti-time">
                            <span class="notification-time">2 days ago</span>
                          </p>
                        </div>
                      </div>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="topnav-dropdown-footer">
                <a href="activities.html">View all Notifications</a>
              </div>
            </div>
          </li>

          <li class="nav-item dropdown has-arrow main-drop">
            <a
              href="javascript:void(0);"
              class="dropdown-toggle nav-link userset"
              data-bs-toggle="dropdown"
            >
              <span class="user-img"
                ><img src="assets/img/profiles/avator1.jpg" alt="" />
                <span class="status online"></span
              ></span>
            </a>
            <div class="dropdown-menu menu-drop-user">
              <div class="profilename">
                <div class="profileset">
                  <span class="user-img"
                    ><img src="assets/img/profiles/avator1.jpg" alt="" />
                    <span class="status online"></span
                  ></span>
                  <div class="profilesets">
                    <h6>John Doe</h6>
                    <h5>Admin</h5>
                  </div>
                </div>
                <hr class="m-0" />
                <a class="dropdown-item" href="profile.html">
                  <i class="me-2" data-feather="user"></i> My Profile</a
                >
                <a class="dropdown-item" href="generalsettings.html"
                  ><i class="me-2" data-feather="settings"></i>Settings</a
                >
                <hr class="m-0" />
                <a class="dropdown-item logout pb-0" href="login.html"
                  ><img
                    src="assets/img/icons/log-out.svg"
                    class="me-2"
                    alt="img"
                  />Logout</a
                >
              </div>
            </div>
          </li>
        </ul>

        <div class="dropdown mobile-user-menu">
          <a
            href="javascript:void(0);"
            class="nav-link dropdown-toggle"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            ><i class="fa fa-ellipsis-v"></i
          ></a>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="profile.html">My Profile</a>
            <a class="dropdown-item" href="generalsettings.html">Settings</a>
            <a class="dropdown-item" href="login.html">Logout</a>
          </div>
        </div>
      </div>

      <div class="sidebar" id="sidebar">
        <div class="sidebar-inner slimscroll">
          <div id="sidebar-menu" class="sidebar-menu">
            <ul>
              <li class="active">
                <a href="index.html"
                  ><img src="assets/img/icons/dashboard.svg" alt="img" /><span>
                    Dashboard</span
                  >
                </a>
              </li>
              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/product.svg" alt="img" /><span>
                    Inventory</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li><a href="./productlist.html">Inventory List</a></li>
                  <li><a href="./addproduct.html">Add Inventory</a></li>
                  <li><a href="./categorylist.html">Category List</a></li>
                  <li><a href="./addcategory.html">Add Category</a></li>
                  <li>
                    <a href="./subcategorylist.html">Sub Category List</a>
                  </li>
                  <li><a href="./subaddcategory.html">Add Sub Category</a></li>
                </ul>
              </li>
              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/sales1.svg" alt="img" /><span>
                    Events</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li><a href="saleslist.html">Events List</a></li>
                  <li><a href="addevent.html">New Event</a></li>
                </ul>
              </li>

              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/return1.svg" alt="img" /><span>
                    Return</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li>
                    <a href="salesreturnlist.html">Inventory Return List</a>
                  </li>
                  <li>
                    <a href="createsalesreturn.html">Add Inventory Return </a>
                  </li>
                </ul>
              </li>

              <li class="submenu">
                <a href="javascript:void(0);"
                  ><img src="assets/img/icons/time.svg" alt="img" /><span>
                    Report</span
                  >
                  <span class="menu-arrow"></span
                ></a>
                <ul>
                  <li>
                    <a href="./purchaseorderreport.html">Event Order report</a>
                  </li>
                  <li><a href="./inventoryreport.html">Inventory Report</a></li>
                  <li>
                    <a href="./invoicereport.html">Inventory Return Report</a>
                  </li>
                  <li><a href="./purchasereport.html">Purchase Report</a></li>
                </ul>
              </li>
              
            </ul>
          </div>
        </div>
      </div>

      <div class="page-wrapper">
        <div class="content">
          <div class="page-header">
            <div class="page-title">
              <h4>Event Add</h4>
              <h6>Create new event</h6>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Event Name</label>
                    <input type="text" placeholder="Enter Event Name" />
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Event Date</label>
                    <input type="date" />
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Event Status</label>
                    <select class="select">
                      <option>Upcoming</option>
                      <option>Ongoing</option>
                      <option>Completed</option>
                      <option>Cancelled</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Description</label>
                    <textarea
                      class="form-control"
                      placeholder="Enter Event Description"
                    ></textarea>
                  </div>
                </div>

                <div class="col-lg-12">
                  <div class="card-header">
                    <h5>Product Selection</h5>
                  </div>
                </div>

                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Product</label>
                    <select class="select">
                      <option>Select Product</option>
                      <option>Laptop</option>
                      <option>Projector</option>
                      <option>Furniture</option>
                      <option>Sound System</option>
                      <option>Decoration Items</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Category</label>
                    <select class="select">
                      <option>Select Category</option>
                      <option>Electronics</option>
                      <option>Furniture</option>
                      <option>Decorations</option>
                      <option>Audio Equipment</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Sub Category</label>
                    <select class="select">
                      <option>Select Sub Category</option>
                      <option>Displays</option>
                      <option>Seating</option>
                      <option>Lighting</option>
                      <option>Speakers</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Brand</label>
                    <select class="select">
                      <option>Select Brand</option>
                      <option>Dell</option>
                      <option>Sony</option>
                      <option>IKEA</option>
                      <option>JBL</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-4 col-sm-6 col-12">
                  <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" placeholder="Enter Quantity" min="1" />
                  </div>
                </div>

                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Product Requirements Note</label>
                    <textarea
                      class="form-control"
                      placeholder="Special requirements for the products"
                    ></textarea>
                  </div>
                </div>

                <div class="col-lg-12 mt-3">
                  <button id="addProductBtn" class="btn btn-primary">
                    Add Another Product
                  </button>
                </div>

                <div class="col-lg-12 mt-4">
                  <a href="javascript:void(0);" class="btn btn-submit me-2"
                    >Create Event</a
                  >
                  <a href="saleslist.html" class="btn btn-cancel">Cancel</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="assets/js/jquery-3.6.0.min.js"></script>

    <script src="assets/js/feather.min.js"></script>

    <script src="assets/js/jquery.slimscroll.min.js"></script>

    <script src="assets/js/jquery.dataTables.min.js"></script>
    <script src="assets/js/dataTables.bootstrap4.min.js"></script>

    <script src="assets/js/bootstrap.bundle.min.js"></script>

    <script src="assets/plugins/select2/js/select2.min.js"></script>

    <script src="assets/plugins/sweetalert/sweetalert2.all.min.js"></script>
    <script src="assets/plugins/sweetalert/sweetalerts.min.js"></script>

    <script src="assets/js/script.js"></script>

    <script type="module">
      import { auth, db } from "./assets/js/firebase.js";
      import {
        collection,
        addDoc,
        getDocs,
        query,
        where,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

      // Firebase event form submission code
      // Firebase event form submission code
      // Firebase product selection integration with enhanced error handling
      document.addEventListener("DOMContentLoaded", function () {
        // Set up logging function for debugging
        const debug = (message, data = null) => {
          console.log(`[Product Selection] ${message}`, data || "");
        };

        debug("Initializing product selection component");

        // Function to change the order of selects to match intended flow
        function reorderSelects() {
          try {
            debug("Reordering select elements for correct flow");

            // Get the product selection section container
            const productSelectionSection =
              document.querySelector(".card-body > .row");

            // Find all select-containing form groups
            const formGroups = productSelectionSection.querySelectorAll(
              ".form-group:has(select.select)"
            );

            // Check if we found the elements
            if (formGroups.length >= 4) {
              // Store references to the form groups
              const productFormGroup = Array.from(formGroups).find(
                (group) =>
                  group.querySelector("label").textContent === "Product"
              );
              const categoryFormGroup = Array.from(formGroups).find(
                (group) =>
                  group.querySelector("label").textContent === "Category"
              );
              const subcategoryFormGroup = Array.from(formGroups).find(
                (group) =>
                  group.querySelector("label").textContent === "Sub Category"
              );
              const brandFormGroup = Array.from(formGroups).find(
                (group) => group.querySelector("label").textContent === "Brand"
              );

              // Get parent column elements
              const productColumn = productFormGroup
                ? productFormGroup.parentElement
                : null;
              const categoryColumn = categoryFormGroup
                ? categoryFormGroup.parentElement
                : null;
              const subcategoryColumn = subcategoryFormGroup
                ? subcategoryFormGroup.parentElement
                : null;

              // Only reorder if we found all necessary elements
              if (productColumn && categoryColumn && subcategoryColumn) {
                // Save original position reference for product column
                const referenceNode = productColumn.nextSibling;
                const parentNode = productColumn.parentNode;

                // Reorder: first category, then subcategory, then product
                parentNode.insertBefore(categoryColumn, referenceNode);
                parentNode.insertBefore(subcategoryColumn, referenceNode);
                parentNode.insertBefore(productColumn, referenceNode);

                debug("Select elements reordered successfully");
                return true;
              }
            }

            debug("Could not find all necessary elements for reordering");
            return false;
          } catch (error) {
            debug("Error reordering selects:", error);
            return false;
          }
        }

        // First attempt to reorder the select elements for better UX
        reorderSelects();

        // Initialize Firebase and load data
        initializeProductSelection();

        async function initializeProductSelection() {
          try {
            debug("Loading Firebase modules");

            // Load Firebase dynamically
            const { auth, db } = await import("./assets/js/firebase.js").catch(
              (error) => {
                debug("Error importing Firebase module:", error);
                throw new Error("Could not load Firebase module");
              }
            );

            const { collection, getDocs, query, where, doc, getDoc } =
              await import(
                "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js"
              ).catch((error) => {
                debug("Error importing Firestore module:", error);
                throw new Error("Could not load Firestore module");
              });

            debug("Firebase modules loaded successfully");

            // Find all select elements by their labels
            const findSelectByLabel = (label) => {
              const labelElements = Array.from(
                document.querySelectorAll(".form-group label")
              );
              const targetLabel = labelElements.find(
                (el) => el.textContent === label
              );
              return targetLabel
                ? targetLabel
                    .closest(".form-group")
                    .querySelector("select.select")
                : null;
            };

            // Get main form elements
            const mainCategorySelect = findSelectByLabel("Category");
            const mainSubCategorySelect = findSelectByLabel("Sub Category");
            const mainProductSelect = findSelectByLabel("Product");
            const mainBrandSelect = findSelectByLabel("Brand");

            debug("Main selects found:", {
              category: !!mainCategorySelect,
              subCategory: !!mainSubCategorySelect,
              product: !!mainProductSelect,
              brand: !!mainBrandSelect,
            });

            if (
              !mainCategorySelect ||
              !mainSubCategorySelect ||
              !mainProductSelect
            ) {
              throw new Error("Could not find all required select elements");
            }

            // Clear and initialize selects
            initializeSelect(mainCategorySelect, "Select Category");
            initializeSelect(mainSubCategorySelect, "Select Sub Category");
            initializeSelect(mainProductSelect, "Select Product");
            if (mainBrandSelect)
              initializeSelect(mainBrandSelect, "Select Brand");

            // Disable selects initially
            mainSubCategorySelect.disabled = true;
            mainProductSelect.disabled = true;

            // Load categories from Firebase
            await loadCategories(mainCategorySelect);

            // Event listener for category selection
            mainCategorySelect.addEventListener("change", async function () {
              const selectedCategory = this.value;
              debug("Category selected:", selectedCategory);

              if (selectedCategory && selectedCategory !== "Select Category") {
                // Reset subsequent dropdowns
                initializeSelect(mainSubCategorySelect, "Select Sub Category");
                initializeSelect(mainProductSelect, "Select Product");

                // Enable subcategory dropdown and load options
                mainSubCategorySelect.disabled = false;
                await loadSubcategories(
                  mainSubCategorySelect,
                  selectedCategory
                );

                // Disable product dropdown until subcategory is selected
                mainProductSelect.disabled = true;
              } else {
                // Reset and disable subsequent dropdowns
                initializeSelect(mainSubCategorySelect, "Select Sub Category");
                initializeSelect(mainProductSelect, "Select Product");
                mainSubCategorySelect.disabled = true;
                mainProductSelect.disabled = true;
              }
            });

            // Event listener for subcategory selection
            mainSubCategorySelect.addEventListener("change", async function () {
              const selectedCategory = mainCategorySelect.value;
              const selectedSubcategory = this.value;
              debug("Subcategory selected:", selectedSubcategory);

              if (
                selectedSubcategory &&
                selectedSubcategory !== "Select Sub Category"
              ) {
                // Reset product dropdown
                initializeSelect(mainProductSelect, "Select Product");

                // Enable product dropdown and load options
                mainProductSelect.disabled = false;
                await loadProducts(
                  mainProductSelect,
                  selectedCategory,
                  selectedSubcategory
                );
              } else {
                // Reset and disable product dropdown
                initializeSelect(mainProductSelect, "Select Product");
                mainProductSelect.disabled = true;
              }
            });

            // Event listener for product selection
            if (mainBrandSelect) {
              mainProductSelect.addEventListener("change", async function () {
                const selectedProduct = this.value;
                debug("Product selected:", selectedProduct);

                if (selectedProduct && selectedProduct !== "Select Product") {
                  // Load brands associated with the selected product
                  await loadBrandsForProduct(mainBrandSelect, selectedProduct);
                } else {
                  // Reset brand dropdown
                  initializeSelect(mainBrandSelect, "Select Brand");
                }
              });
            }

            // Add product button - add event listeners to new sections
            $("#addProductBtn").click(function () {
              debug("Add product button clicked");

              // Wait for the new section to be added to the DOM
              setTimeout(async function () {
                // Get the newly added product section
                const newSection = $(".product-section").last();
                debug("New product section added");

                // Find all select elements in this section
                const selects = newSection.find("select.select");

                if (selects.length < 3) {
                  debug("Not enough select elements found in new section");
                  return;
                }

                // Get the selects by their label text
                const labels = newSection
                  .find(".form-group label")
                  .map(function () {
                    return $(this).text().trim();
                  })
                  .get();

                let categorySelectIndex = labels.indexOf("Category");
                let subcategorySelectIndex = labels.indexOf("Sub Category");
                let productSelectIndex = labels.indexOf("Product");
                let brandSelectIndex = labels.indexOf("Brand");

                // Default fallback in case labels don't match
                if (categorySelectIndex === -1) categorySelectIndex = 1;
                if (subcategorySelectIndex === -1) subcategorySelectIndex = 2;
                if (productSelectIndex === -1) productSelectIndex = 0;
                if (brandSelectIndex === -1) brandSelectIndex = 3;

                const categorySelect = selects.eq(categorySelectIndex)[0];
                const subcategorySelect = selects.eq(subcategorySelectIndex)[0];
                const productSelect = selects.eq(productSelectIndex)[0];
                const brandSelect =
                  brandSelectIndex >= 0
                    ? selects.eq(brandSelectIndex)[0]
                    : null;

                // Initialize selects
                initializeSelect(categorySelect, "Select Category");
                initializeSelect(subcategorySelect, "Select Sub Category");
                initializeSelect(productSelect, "Select Product");
                if (brandSelect) initializeSelect(brandSelect, "Select Brand");

                // Disable selects initially
                $(subcategorySelect).prop("disabled", true);
                $(productSelect).prop("disabled", true);

                // Load categories for this section
                await loadCategories(categorySelect);

                // Add event listeners for this section
                setupSectionEventListeners(
                  categorySelect,
                  subcategorySelect,
                  productSelect,
                  brandSelect
                );
              }, 200);
            });

            // Function to set up event listeners for a product section
            function setupSectionEventListeners(
              categorySelect,
              subcategorySelect,
              productSelect,
              brandSelect
            ) {
              debug(
                "Setting up event listeners for additional product section"
              );

              // Category change event
              $(categorySelect).on("change", async function () {
                const selectedCategory = this.value;
                debug(
                  "Additional section - Category selected:",
                  selectedCategory
                );

                if (
                  selectedCategory &&
                  selectedCategory !== "Select Category"
                ) {
                  // Reset subsequent dropdowns
                  initializeSelect(subcategorySelect, "Select Sub Category");
                  initializeSelect(productSelect, "Select Product");

                  // Enable subcategory dropdown and load options
                  $(subcategorySelect).prop("disabled", false);
                  await loadSubcategories(subcategorySelect, selectedCategory);

                  // Disable product dropdown until subcategory is selected
                  $(productSelect).prop("disabled", true);
                } else {
                  // Reset and disable subsequent dropdowns
                  initializeSelect(subcategorySelect, "Select Sub Category");
                  initializeSelect(productSelect, "Select Product");
                  $(subcategorySelect).prop("disabled", true);
                  $(productSelect).prop("disabled", true);
                }
              });

              // Subcategory change event
              $(subcategorySelect).on("change", async function () {
                const selectedCategory = $(categorySelect).val();
                const selectedSubcategory = this.value;
                debug(
                  "Additional section - Subcategory selected:",
                  selectedSubcategory
                );

                if (
                  selectedSubcategory &&
                  selectedSubcategory !== "Select Sub Category"
                ) {
                  // Reset product dropdown
                  initializeSelect(productSelect, "Select Product");

                  // Enable product dropdown and load options
                  $(productSelect).prop("disabled", false);
                  await loadProducts(
                    productSelect,
                    selectedCategory,
                    selectedSubcategory
                  );
                } else {
                  // Reset and disable product dropdown
                  initializeSelect(productSelect, "Select Product");
                  $(productSelect).prop("disabled", true);
                }
              });

              // Product change event
              if (brandSelect) {
                $(productSelect).on("change", async function () {
                  const selectedProduct = this.value;
                  debug(
                    "Additional section - Product selected:",
                    selectedProduct
                  );

                  if (selectedProduct && selectedProduct !== "Select Product") {
                    // Load brands associated with the selected product
                    await loadBrandsForProduct(brandSelect, selectedProduct);
                  } else {
                    // Reset brand dropdown
                    initializeSelect(brandSelect, "Select Brand");
                  }
                });
              }
            }

            // Function to initialize a select element
            function initializeSelect(selectElement, placeholderText) {
              if (!selectElement) {
                debug("Cannot initialize null select element");
                return;
              }

              debug("Initializing select element:", placeholderText);

              // Clear existing options
              selectElement.innerHTML = "";

              // Add placeholder option
              const placeholderOption = document.createElement("option");
              placeholderOption.textContent = placeholderText;
              placeholderOption.value = "";
              selectElement.appendChild(placeholderOption);

              // Refresh select2 if it's initialized
              try {
                $(selectElement).trigger("change");
              } catch (e) {
                debug("Select2 refresh failed:", e);
              }
            }

            // Function to load categories from Firebase
            async function loadCategories(selectElement) {
              if (!selectElement) {
                debug("Cannot load categories for null select element");
                return;
              }

              debug("Loading categories from Firebase");

              try {
                // Check if the categories collection exists
                let categoriesSnapshot = await getDocs(
                  collection(db, "categories")
                ).catch((error) => {
                  debug("Error fetching categories collection:", error);
                  return { empty: true, docs: [] };
                });

                // If no categories collection or it's empty, try categories_list as a fallback
                if (categoriesSnapshot.empty) {
                  debug(
                    "Categories collection is empty, trying categories_list"
                  );
                  categoriesSnapshot = await getDocs(
                    collection(db, "categories_list")
                  ).catch((error) => {
                    debug("Error fetching categories_list collection:", error);
                    return { empty: true, docs: [] };
                  });
                }

                // Clear existing options (except placeholder)
                initializeSelect(selectElement, "Select Category");

                // Check if we got any categories
                if (categoriesSnapshot.empty) {
                  debug("No categories found in any collection");

                  // Add a sample category as fallback
                  const option = document.createElement("option");
                  option.value = "sample_category";
                  option.textContent = "Sample Category";
                  selectElement.appendChild(option);

                  debug("Added sample category as fallback");
                } else {
                  // Add categories to select
                  debug(`Found ${categoriesSnapshot.docs.length} categories`);

                  categoriesSnapshot.forEach((doc) => {
                    const category = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent =
                      category.name ||
                      category.categoryName ||
                      category.title ||
                      `Category ${doc.id}`;
                    selectElement.appendChild(option);
                  });
                }

                // Refresh select2
                try {
                  $(selectElement).trigger("change");
                } catch (e) {
                  debug("Select2 refresh failed after loading categories:", e);
                }
              } catch (error) {
                debug("Unexpected error loading categories:", error);
                throw error;
              }
            }

            // Function to load subcategories based on selected category
            async function loadSubcategories(selectElement, categoryId) {
              if (!selectElement) {
                debug("Cannot load subcategories for null select element");
                return;
              }

              debug("Loading subcategories for category:", categoryId);

              try {
                // Clear existing options
                initializeSelect(selectElement, "Select Sub Category");

                // Try different collection names and field names for flexibility
                let subcategoriesSnapshot = { empty: true, docs: [] };
                let collections = [
                  "subcategories",
                  "sub_categories",
                  "subcategory_list",
                ];
                let fieldNames = [
                  "categoryId",
                  "category_id",
                  "parentId",
                  "parent_id",
                  "parentCategoryId",
                ];
                // Try each collection and field combination until we find subcategories
                for (let collectionName of collections) {
                  for (let fieldName of fieldNames) {
                    debug(
                      `Trying to load subcategories from "${collectionName}" where ${fieldName}="${categoryId}"`
                    );

                    subcategoriesSnapshot = await getDocs(
                      query(
                        collection(db, collectionName),
                        where(fieldName, "==", categoryId)
                      )
                    ).catch((error) => {
                      debug(
                        `Error querying ${collectionName} with ${fieldName}:`,
                        error
                      );
                      return { empty: true, docs: [] };
                    });

                    if (!subcategoriesSnapshot.empty) {
                      debug(
                        `Found subcategories in ${collectionName} with ${fieldName}`
                      );
                      break;
                    }
                  }

                  if (!subcategoriesSnapshot.empty) break;
                }

                // Check if we found any subcategories
                if (subcategoriesSnapshot.empty) {
                  debug("No subcategories found, using fallback sample data");

                  // Add sample subcategories as fallback
                  const sampleSubcategories = [
                    {
                      id: "sample_subcategory_1",
                      name: "Sample Subcategory 1",
                    },
                    {
                      id: "sample_subcategory_2",
                      name: "Sample Subcategory 2",
                    },
                  ];

                  sampleSubcategories.forEach((subcategory) => {
                    const option = document.createElement("option");
                    option.value = subcategory.id;
                    option.textContent = subcategory.name;
                    selectElement.appendChild(option);
                  });
                } else {
                  // Add subcategories to select
                  debug(
                    `Found ${subcategoriesSnapshot.docs.length} subcategories`
                  );

                  subcategoriesSnapshot.forEach((doc) => {
                    const subcategory = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent =
                      subcategory.name ||
                      subcategory.subcategoryName ||
                      subcategory.title ||
                      `Subcategory ${doc.id}`;
                    selectElement.appendChild(option);
                  });
                }

                // Refresh select2
                try {
                  $(selectElement).trigger("change");
                } catch (e) {
                  debug(
                    "Select2 refresh failed after loading subcategories:",
                    e
                  );
                }
              } catch (error) {
                debug("Unexpected error loading subcategories:", error);
                throw error;
              }
            }

            // Function to load products based on selected category and subcategory
            async function loadProducts(
              selectElement,
              categoryId,
              subcategoryId
            ) {
              if (!selectElement) {
                debug("Cannot load products for null select element");
                return;
              }

              debug(
                "Loading products for category/subcategory:",
                categoryId,
                subcategoryId
              );

              try {
                // Clear existing options
                initializeSelect(selectElement, "Select Product");

                // Try different collection names for flexibility
                let productsSnapshot = { empty: true, docs: [] };
                let collections = ["products", "product_list"];
                let categoryFieldNames = ["categoryId", "category_id"];
                let subcategoryFieldNames = [
                  "subcategoryId",
                  "subcategory_id",
                  "subCategoryId",
                ];

                // Try each collection with different query approaches
                for (let collectionName of collections) {
                  debug(`Trying to load products from "${collectionName}"`);

                  // Try querying with both category and subcategory fields
                  for (let catField of categoryFieldNames) {
                    for (let subCatField of subcategoryFieldNames) {
                      debug(
                        `Querying ${collectionName} where ${catField}="${categoryId}" and ${subCatField}="${subcategoryId}"`
                      );

                      productsSnapshot = await getDocs(
                        query(
                          collection(db, collectionName),
                          where(catField, "==", categoryId),
                          where(subCatField, "==", subcategoryId)
                        )
                      ).catch((error) => {
                        debug(
                          `Error querying ${collectionName} with combined fields:`,
                          error
                        );
                        return { empty: true, docs: [] };
                      });

                      if (!productsSnapshot.empty) {
                        debug(
                          `Found products in ${collectionName} with ${catField} and ${subCatField}`
                        );
                        break;
                      }
                    }

                    if (!productsSnapshot.empty) break;
                  }

                  // If we haven't found products yet, try with just subcategory
                  if (productsSnapshot.empty) {
                    for (let subCatField of subcategoryFieldNames) {
                      debug(
                        `Querying ${collectionName} where ${subCatField}="${subcategoryId}"`
                      );

                      productsSnapshot = await getDocs(
                        query(
                          collection(db, collectionName),
                          where(subCatField, "==", subcategoryId)
                        )
                      ).catch((error) => {
                        debug(
                          `Error querying ${collectionName} with ${subCatField}:`,
                          error
                        );
                        return { empty: true, docs: [] };
                      });

                      if (!productsSnapshot.empty) {
                        debug(
                          `Found products in ${collectionName} with ${subCatField}`
                        );
                        break;
                      }
                    }
                  }

                  if (!productsSnapshot.empty) break;
                }

                // Check if we found any products
                if (productsSnapshot.empty) {
                  debug("No products found, using fallback sample data");

                  // Add sample products as fallback
                  const sampleProducts = [
                    { id: "sample_product_1", name: "Sample Product 1" },
                    { id: "sample_product_2", name: "Sample Product 2" },
                    { id: "sample_product_3", name: "Sample Product 3" },
                  ];

                  sampleProducts.forEach((product) => {
                    const option = document.createElement("option");
                    option.value = product.id;
                    option.textContent = product.name;
                    selectElement.appendChild(option);
                  });
                } else {
                  // Add products to select
                  debug(`Found ${productsSnapshot.docs.length} products`);

                  productsSnapshot.forEach((doc) => {
                    const product = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent =
                      product.name ||
                      product.productName ||
                      product.title ||
                      `Product ${doc.id}`;
                    selectElement.appendChild(option);
                  });
                }

                // Refresh select2
                try {
                  $(selectElement).trigger("change");
                } catch (e) {
                  debug("Select2 refresh failed after loading products:", e);
                }
              } catch (error) {
                debug("Unexpected error loading products:", error);
                throw error;
              }
            }

            // Function to load brands for a selected product
            async function loadBrandsForProduct(selectElement, productId) {
              if (!selectElement) {
                debug("Cannot load brands for null select element");
                return;
              }

              debug("Loading brands for product:", productId);

              try {
                // Clear existing options
                initializeSelect(selectElement, "Select Brand");

                // Try to get the product document to find associated brands
                let productDoc = null;
                let collections = ["products", "product_list"];

                for (let collectionName of collections) {
                  debug(
                    `Trying to load product from "${collectionName}" with id ${productId}`
                  );

                  productDoc = await getDoc(
                    doc(db, collectionName, productId)
                  ).catch((error) => {
                    debug(
                      `Error getting product document from ${collectionName}:`,
                      error
                    );
                    return null;
                  });

                  if (productDoc && productDoc.exists()) {
                    debug(`Found product in ${collectionName}`);
                    break;
                  }
                }

                // If we found the product, look for its brands
                if (productDoc && productDoc.exists()) {
                  const product = productDoc.data();

                  // Check if the product has a brands array or brandIds array
                  const brandIds =
                    product.brands ||
                    product.brandIds ||
                    product.brand_ids ||
                    [];

                  if (Array.isArray(brandIds) && brandIds.length > 0) {
                    debug(`Product has ${brandIds.length} associated brands`);

                    // Try to get each brand
                    const brandsCollections = ["brands", "brand_list"];

                    for (const brandId of brandIds) {
                      let brandDoc = null;

                      for (let brandCollection of brandsCollections) {
                        brandDoc = await getDoc(
                          doc(db, brandCollection, brandId)
                        ).catch((error) => {
                          debug(
                            `Error getting brand from ${brandCollection}:`,
                            error
                          );
                          return null;
                        });

                        if (brandDoc && brandDoc.exists()) {
                          const brand = brandDoc.data();
                          const option = document.createElement("option");
                          option.value = brandId;
                          option.textContent =
                            brand.name ||
                            brand.brandName ||
                            brand.title ||
                            `Brand ${brandId}`;
                          selectElement.appendChild(option);
                          break;
                        }
                      }
                    }
                  } else {
                    debug(
                      "Product has no associated brands, using fallback data"
                    );
                    addFallbackBrands();
                  }
                } else {
                  debug("Could not find product document, using fallback data");
                  addFallbackBrands();
                }

                // Refresh select2
                try {
                  $(selectElement).trigger("change");
                } catch (e) {
                  debug("Select2 refresh failed after loading brands:", e);
                }
              } catch (error) {
                debug("Unexpected error loading brands:", error);
                throw error;
              }

              // Helper function to add fallback brands
              function addFallbackBrands() {
                const sampleBrands = [
                  { id: "sample_brand_1", name: "Sample Brand 1" },
                  { id: "sample_brand_2", name: "Sample Brand 2" },
                ];

                sampleBrands.forEach((brand) => {
                  const option = document.createElement("option");
                  option.value = brand.id;
                  option.textContent = brand.name;
                  selectElement.appendChild(option);
                });
              }
            }

            debug("Product selection component fully initialized");
          } catch (error) {
            debug("Critical error in product selection component:", error);
            console.error("Product Selection Component Error:", error);

            // Display user-friendly error message
            showErrorMessage(
              "There was an error loading product data. Please refresh the page or contact support if the issue persists."
            );
          }
        }

        // Function to show error message to user
        function showErrorMessage(message) {
          // Try to find a suitable element to show the error
          const productSelectionSection =
            document.querySelector(".card-body > .row");

          if (productSelectionSection) {
            // Create an error alert
            const errorDiv = document.createElement("div");
            errorDiv.className = "alert alert-danger mt-3";
            errorDiv.role = "alert";
            errorDiv.textContent = message;

            // Insert at the beginning of the section
            productSelectionSection.insertBefore(
              errorDiv,
              productSelectionSection.firstChild
            );
          } else {
            // Fallback to alert if we can't find a good place to show the error
            alert(message);
          }
        }
      });
    </script>

    <script>
      // Function to add another product section
      $(document).ready(function () {
        $("#addProductBtn").click(function () {
          // Clone the product selection section
          const productSection = `
            <div class="row product-section mt-4 pt-3 border-top">
              <div class="col-lg-12">
                <div class="card-header">
                  <h5>Additional Product</h5>
                </div>
              </div>
              
              <div class="col-lg-4 col-sm-6 col-12">
                <div class="form-group">
                  <label>Product</label>
                  <select class="select">
                    <option>Select Product</option>
                    <option>Laptop</option>
                    <option>Projector</option>
                    <option>Furniture</option>
                    <option>Sound System</option>
                    <option>Decoration Items</option>
                  </select>
                </div>
              </div>
              <div class="col-lg-4 col-sm-6 col-12">
                <div class="form-group">
                  <label>Category</label>
                  <select class="select">
                    <option>Select Category</option>
                    <option>Electronics</option>
                    <option>Furniture</option>
                    <option>Decorations</option>
                    <option>Audio Equipment</option>
                  </select>
                </div>
              </div>
              <div class="col-lg-4 col-sm-6 col-12">
                <div class="form-group">
                  <label>Sub Category</label>
                  <select class="select">
                    <option>Select Sub Category</option>
                    <option>Displays</option>
                    <option>Seating</option>
                    <option>Lighting</option>
                    <option>Speakers</option>
                  </select>
                </div>
              </div>
              <div class="col-lg-4 col-sm-6 col-12">
                <div class="form-group">
                  <label>Brand</label>
                  <select class="select">
                    <option>Select Brand</option>
                    <option>Dell</option>
                    <option>Sony</option>
                    <option>IKEA</option>
                    <option>JBL</option>
                  </select>
                </div>
              </div>
              <div class="col-lg-4 col-sm-6 col-12">
                <div class="form-group">
                  <label>Quantity</label>
                  <input type="number" placeholder="Enter Quantity" min="1" />
                </div>
              </div>
              <div class="col-lg-4 col-sm-6 col-12">
                <div class="form-group">
                  <button class="btn btn-danger remove-product">Remove</button>
                </div>
              </div>
            </div>
          `;

          // Insert before the add product button
          $(productSection).insertBefore($("#addProductBtn").parent().parent());

          // Initialize select2 for the new dropdowns
          $(".select").select2();

          // Add remove functionality
          $(".remove-product").click(function () {
            $(this).closest(".product-section").remove();
          });
        });
      });
    </script>
  </body>
</html>
